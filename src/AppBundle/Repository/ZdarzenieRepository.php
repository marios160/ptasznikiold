<?php

namespace AppBundle\Repository;

use Doctrine\ORM\Tools\Pagination\Paginator;
/**
 * ZdarzenieRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class ZdarzenieRepository extends \Doctrine\ORM\EntityRepository
{
    
    public function findBySession($session, $currentPage = 1, $limit) {
        $query = "SELECT z.id, t.nazwa as typZdarzenia, "
                . "CONCAT(p.imie,' ',p.nazwisko) as pracownik , pt.kodEan as ptasznik, z.data, z.opis,"
                . " m.nazwa as magazyn, k.nazwa as karma, z.rozmiar, tr.nazwa as terrarium"
                . " FROM AppBundle:Zdarzenie z "
                . "LEFT JOIN AppBundle:TypZdarzenia t WITH z.typZdarzenia=t.id"
                . " LEFT JOIN AppBundle:Pracownik p WITH z.pracownik=p.id"
                . " LEFT JOIN AppBundle:Ptasznik pt WITH z.ptasznik=pt.id"
                . " LEFT JOIN AppBundle:Magazyn m WITH z.magazyn=m.id"
                . " LEFT JOIN AppBundle:Karma k WITH z.karma=k.id"
                . " LEFT JOIN AppBundle:Terrarium tr WITH z.terrarium=tr.id";
        if ($session->get('find')) {
            $find = trim($session->get('find'));
            $query .= " WHERE "
                    . "pt.kodEan LIKE '$find' OR "
                    . "pt.nazwaLacinska LIKE '%$find%' OR "
                    . "t.nazwa LIKE '%$find%' OR "
                    . "t.opis LIKE '%$find%' OR "
                    . "p.nazwisko LIKE '$find' OR "
                    . "p.imie LIKE '$find' OR "
                    . "p.nrTelefonu LIKE '$find' OR "
                    . "p.email LIKE '%$find%' OR "
                    . "p.stanowisko LIKE '%$find%' OR "
                    . "z.data LIKE '%$find%' OR "
                    . "z.opis LIKE '%$find%' OR "
                    . "z.id LIKE '$find' OR "
                    . "z.rozmiar LIKE '%$find%' OR "
                    . "m.nazwa LIKE '%$find%' OR "
                    . "m.nazwaSkrocona LIKE '%$find%' OR "
                    . "k.nazwa LIKE '%$find%' OR "
                    . "k.opis LIKE '%$find%' OR "
                    . "tr.nazwa LIKE '%$find%' OR "
                    . "tr.opis LIKE '%$find%'"
                    ;
        }

        $query .= " ORDER BY z.data DESC, z.id DESC";
        $result = $this->getEntityManager()
                ->createQuery($query);

        $paginator = $this->paginate($result, $currentPage, $limit);

        return $paginator;
    }

    public function paginate($dql, $page = 1, $limit = 10) {
        $paginator = new Paginator($dql);
        $paginator->setUseOutputWalkers(false);

        $paginator->getQuery()
                ->setFirstResult($limit * ($page - 1)) // Offset
                ->setMaxResults($limit); // Limit

        return $paginator;
    }
    
    
    public function findByIds($ids) {
        $query = "SELECT z.id, t.nazwa as typZdarzenia, "
                . "CONCAT(p.imie,' ',p.nazwisko) as pracownik , pt.kodEan as ptasznik, z.data, z.opis"
                . " FROM AppBundle:Zdarzenie z "
                . "LEFT JOIN AppBundle:TypZdarzenia t WITH z.typZdarzenia=t.id"
                . " LEFT JOIN AppBundle:Pracownik p WITH z.pracownik=p.id"
                . " LEFT JOIN AppBundle:Ptasznik pt WITH z.ptasznik=pt.id"
                . " WHERE ";
        $i = 0;
        $len = count($ids) - 1;
        foreach ($ids as $id) {
            $query .= "z.id = $id";
            if ($i < $len)
                $query .= " OR ";
            $i++;
        }
        

        return $this->getEntityManager()->createQuery($query)
                        ->getResult();
    }

}
